<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>게시글 상세</title>
</head>
<body>
<nav>
    <a href="/">홈</a> |
    <a href="/board/list">게시판</a> |
    <a href="/file/read?note_id=1">파일 업로드</a> |
    <a href="/login">로그인</a> |
    <a href="/register">회원가입</a> |
    <a href="/admin">관리자</a>
</nav>
<hr>

<h2>게시글 상세 보기</h2>

<p><strong>제목:</strong> <span th:text="${note.title}">제목</span></p>
<p><strong>작성자 ID:</strong> <span th:text="${note.userId}">작성자</span></p>
<p><strong>작성일:</strong> <span th:text="${#temporals.format(note.createDate, 'yyyy-MM-dd HH:mm')}">작성일</span></p>
<p><strong>내용:</strong> <span th:text="${note.content}">내용</span></p>

<a th:href="@{|/note/modify?id=${note.id}|}">[수정]</a> |
<a href="#" onclick="deleteNote();">[삭제]</a> |
<a href="/note/list">[목록]</a>

<br><br><br>

<!-- 댓글 영역 -->
<div class="cm_list">
    <fieldset>
        <legend>댓글 작성</legend>
        <form class="comment-form" enctype="multipart/form-data">
            <input type="hidden" name="noteId" th:value="${note.id}" />
            <input type="hidden" name="commentAuthorId" th:value="${note.userId}" />
            <textarea name="content" rows="4" cols="90" placeholder="댓글을 입력해 주세요."></textarea><br>
            <input type="file" name="imageFile" accept="image/*" /><br>
            <button type="submit">등록</button>
        </form>
    </fieldset>

    <h3>댓글 목록</h3>
    <ul id="comment-list"></ul>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    const noteId = $('input[name="noteId"]').val();
    const userId = $('input[name="commentAuthorId"]').val();

    function renderComment(comment, depth = 0) {
        const isReply = depth > 0;
        const padding = isReply ? 'style="margin-left:30px;"' : '';
        let html = `<li ${padding} data-id="${comment.id}">
            <div>
                <strong>${comment.commentAuthorId}</strong> (${comment.lastModifiedDate})<br>
                ${comment.images ? `<img src="/comments/images?id=${comment.id}" style="max-width:200px;"><br>` : ''}
                <p>${comment.content}</p>
                <button class="edit-btn">수정</button>
                <button class="delete-btn">삭제</button>
                ${!isReply ? `<button class="reply-toggle-btn">답글쓰기</button>` : ''}
            </div>

            <form class="edit-form" style="display:none;" enctype="multipart/form-data">
                <input type="hidden" name="id" value="${comment.id}">
                <textarea name="content" rows="3" cols="80">${comment.content}</textarea><br>
                <input type="file" name="imageFile"><br>
                <button type="submit">수정완료</button>
                <button type="button" class="cancel-edit">취소</button>
            </form>

            ${!isReply ? `
            <form class="reply-form" style="display:none;" enctype="multipart/form-data">
                <input type="hidden" name="noteId" value="${noteId}">
                <input type="hidden" name="commentAuthorId" value="${userId}">
                <input type="hidden" name="commentId" value="${comment.id}">
                <textarea name="content" rows="3" cols="80" placeholder="답글을 입력하세요"></textarea><br>
                <input type="file" name="imageFile"><br>
                <button type="submit">등록</button>
                <button type="button" class="reply-cancel-btn">취소</button>
            </form>` : ''}
        `;

        if (comment.children && comment.children.length > 0) {
            html += '<ul>';
            comment.children.forEach(reply => {
                html += renderComment(reply, depth + 1);
            });
            html += '</ul>';
        }

        html += '</li>';
        return html;
    }

    function loadComments() {
        $.getJSON(`/comments/json?noteId=${noteId}`, function(data) {
            let listHtml = '';
            data.forEach(comment => {
                listHtml += renderComment(comment);
            });
            $('#comment-list').html(listHtml);
        });
    }

    $(document).ready(function() {
        loadComments();

        // 댓글 등록
        $(document).on('submit', '.comment-form', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            $.ajax({
                url: '/comments/ajax/add',
                method: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function() {
                    loadComments();
                    $('.comment-form')[0].reset();
                }
            });
        });

        // 댓글 삭제
        $(document).on('click', '.delete-btn', function() {
            const id = $(this).closest('li').data('id');
            $.post('/comments/ajax/delete', { id }, function() {
                loadComments();
            });
        });

        // 수정 폼 열기/닫기
        $(document).on('click', '.edit-btn', function() {
            const $li = $(this).closest('li');
            const isReply = $li.data('reply');

            // 대댓글이 아닌 경우에만 수정 폼을 토글
            if (!isReply) {
                $li.find('.edit-form').toggle();
                $li.find('div').toggle();
            }
        });
        $(document).on('click', '.cancel-edit', function() {
            const $li = $(this).closest('li');
            $li.find('.edit-form').hide();
            $li.find('div').show();
        });

        // 댓글 수정 제출
        $(document).on('submit', '.edit-form', function(e) {
            e.preventDefault();
            const formData = new FormData(this); // 수정 폼의 데이터를 가져옴
            $.ajax({
                url: '/comments/ajax/update',  // 업데이트 URL
                method: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    loadComments();  // 댓글 목록 새로고침
                },
                error: function(xhr, status, error) {
                    console.error("댓글 수정 오류:", error);
                }
            });
        });

        // 답글 폼 열기/닫기
        $(document).on('click', '.reply-toggle-btn', function() {
            const $li = $(this).closest('li');
            $li.find('.reply-form').show();
            $(this).hide();
        });
        $(document).on('click', '.reply-cancel-btn', function() {
            const $li = $(this).closest('li');
            $li.find('.reply-form').hide();
            $li.find('.reply-toggle-btn').show();
        });

        // 답글 등록
        $(document).on('submit', '.reply-form', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            $.ajax({
                url: '/comments/ajax/add',
                method: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function() {
                    loadComments();
                }
            });
        });
    });
</script>
</body>
</html>
