<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>게시글 상세</title>
</head>
<body>
    <nav>
        <a href="/">홈</a> |
        <a href="/board/list">게시판</a> |
        <a href="/file/read?note_id=1">파일 업로드</a> |
        <a href="/login">로그인</a> |
        <a href="/register">회원가입</a> |
        <a href="/admin">관리자</a>
    </nav>
    <hr>

    <h2>게시글 상세 보기</h2>
    
    <p><strong>제목:</strong> <span th:text="${note.title}">제목</span></p>
    <p><strong>작성자 ID:</strong> <span th:text="${note.userId}">작성자</span></p>
    <p><strong>작성일:</strong> 
        <span th:text="${#temporals.format(note.createDate, 'yyyy-MM-dd HH:mm')}">작성일</span>
    </p>
    <p><strong>내용:</strong> <span th:text="${note.content}">내용</span></p>

    <a th:href="@{|/note/modify?id=${note.id}|}">[수정]</a> |
    <a href="#" onclick="deleteNote();">[삭제]</a> |
    <a href="/note/list">[목록]</a>

    <input type="hidden" id="noteId" th:value="${note.id}">
    <input type="hidden" id="commentAuthorId" th:value="${note.userId}">

    <br><br><br><br><br><br>

    <!-- 댓글 작성 -->
    <div class="cm_write">
        <fieldset>
            <legend class="skipinfo">댓글 입력</legend>
            <div class="cm_input">
                <p>
                    <textarea id="content" name="content" 
                        onkeyup="countingLength(this);" cols="90" rows="4" 
                        placeholder="댓글을 입력해 주세요."></textarea>
                </p>
                <span>
                    <button type="button" class="btns" onclick="insertComment();">등 록</button> 
                    <i id="counter">0/300자</i>
                </span>
            </div>
        </fieldset>
    </div>

    <!-- 댓글 렌더링 영역 -->
    <div class="cm_list">
    </div>

</body>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- jQuery 추가 -->

<script>
// 댓글 길이 카운팅
function countingLength(content) {
    if (content.value.length > 300) {
        alert('댓글을 300자 이하로 입력해 주세요.');
        content.value = content.value.substring(0, 300);
        content.focus();
    }
    document.getElementById('counter').innerText = content.value.length + '/300자';
}

// 댓글 저장
function insertComment() {
    const content = document.getElementById('content');
    const noteId = document.getElementById('noteId').value;
    const commentAuthorId = document.getElementById('commentAuthorId').value;

    if (!content.value.trim()) {
        alert('댓글을 입력해 주세요.');
        content.focus();
        return;
    }

    const params = {
        noteId: noteId,
        content: content.value,
        writer: commentAuthorId
    };

    $.ajax({
        url: `/posts/${noteId}/comments`,
        type: 'post',
        contentType: 'application/json; charset=utf-8',
        dataType: 'json',
        data: JSON.stringify(params),
        async: false,
        success: function (response) {
            console.log('저장 성공: ', response);
            window.location.reload();
        },
        error: function (request, status, error) {
            console.log('저장 실패: ', error);
        }
    });
}

// 댓글 리스트 조회
function findAllComment() {
    const noteId = document.getElementById('noteId').value;

    $.ajax({
        url: `/posts/${noteId}/comments`,
        type: 'get',
        dataType: 'json',
        async: false,
        success: function (response) {
            if (!response.length) {
                document.querySelector('.cm_list').innerHTML = '<div class="cm_none"><p>등록된 댓글이 없습니다.</p></div>';
                return false;
            }

            let commentHtml = '';

            response.forEach(row => {
                commentHtml += `
                    <div>
                        <span class="writer_img">
                            <img src="/images/default_profile.png" width="30" height="30" alt="기본 프로필 이미지"/>
                        </span>
                        <p class="writer">
                            <em>${row.writer}</em>
                            <span class="date">${row.createDate}</span>
                        </p>
                        <div class="cont">
                            <div class="txt_con">${row.content}</div>
                        </div>
                        <p class="func_btns">
                            <button type="button" class="btns"><span class="icons icon_modify">수정</span></button>
                            <button type="button" class="btns"><span class="icons icon_del">삭제</span></button>
                        </p>
                    </div>
                `;
            });

            document.querySelector('.cm_list').innerHTML = commentHtml;
        },
        error: function (request, status, error) {
            console.log(error);
        }
    });
}

// 게시글 삭제
function deleteNote() {
    const noteId = document.getElementById('noteId').value;

    if (!confirm('정말 삭제하시겠습니까?')) {
        return;
    }

    $.ajax({
        url: `/note/remove?id=${noteId}`,
        type: 'post',
        success: function () {
            alert('삭제되었습니다.');
            window.location.href = '/board/list';
        },
        error: function (request, status, error) {
            console.log('삭제 실패: ', error);
            alert('삭제에 실패했습니다.');
        }
    });
}

window.onload = () => {
    findAllComment();
};
</script>

</html>
