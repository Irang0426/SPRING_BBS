<!DOCTYPE html>
<html lang="ko">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://unpkg.com/dayjs@1.11.9/dayjs.min.js"></script>
<head>
    <meta charset="UTF-8">
    <title>게시글 상세</title>
</head>
<body>
    <nav>
        <a href="/">홈</a> 
        <a href="/board/list">게시판</a> |
        <a href="/upload/list">파일 업로드</a> |
        <a href="/login">로그인</a> |
        <a href="/register">회원가입</a> |
        <a href="/admin/users">관리자</a>
    </nav>
    <hr>
    
    <h2>게시글 상세 보기</h2>
    <p><strong>제목:</strong> Spring Boot 게시판 만들기</p>
    <p><strong>작성자:</strong> admin</p>
    <p><strong>내용:</strong> 이 게시판은 Spring Boot와 Thymeleaf로 구현되었습니다.</p>
    <a href="board_modify.html">[수정]</a> | <a href="board_list.html">[목록]</a>
    <br><br><br><br><br><br>
    
    <!--/* 댓글 작성 */-->
    <div class="cm_write">
        <fieldset>
            <legend class="skipinfo">댓글 입력</legend>
            <div class="cm_input">
                <p><textarea id="content" name="content" onkeyup="countingLength(this);" cols="90" rows="4" placeholder="댓글을 입력해 주세요."></textarea></p>
                <span><button type="button" class="btns" onclick="insertComment();">등 록</button> <i id="counter">0/300자</i></span>
            </div>
        </fieldset>
    </div>
    
    <!--/* 댓글 렌더링 영역 */-->
    <div class="cm_list">

    </div>

</body>
<script th:inline="javascript">
// 댓글 길이 카운팅
function countingLength(content) {
    if (content.value.length > 300) {
        alert('댓글을 300자 이하로 입력해 주세요.');
        content.value = content.value.substring(0, 300);
        content.focus();
    }
    document.getElementById('counter').innerText = content.value.length + '/300자';
}

// 댓글 저장
function insertComment() {

    const content = document.getElementById('content');
    isValid(content, '댓글');
    if (!content.value.trim()) {
        alert('댓글을 입력해 주세요.');
        content.focus();
        return;
    }
    
    const noteId = [[ ${comments?.noteId} ]];
    const commentAuthorId = [[ ${comments?.commentAuthorId} ]];
    if (!noteId) {
        alert('게시글 정보가 없습니다.');
        return;
    }
    
    const params = {
       noteId : noteId,
        content : content.value,
        writer : commentAuthorId
    }

    $.ajax({
        url : `/posts/${noteId}/comments`,
        type : 'post',
        contentType : 'application/json; charset=utf-8',
        dataType : 'json',
        data : JSON.stringify(params),
        async : false,
        success : function (response) {
            console.log('저장 성공: ', response);
            // 저장 성공 시 페이지 새로고침
            window.location.reload();
            findAllComment();
        },
        error : function (request, status, error) {
            console.log('저장 실패: ', error)
        }
    });
    
    // 댓글 리스트 조회
    function findAllComment() {
       
       const noteId = [[ ${comments?.noteId} ]];
       
       $.ajax({
          url : `/posts/${noteId}/comments`,
          type : 'get',
          dataType : 'json',
          async : false,
          success : function (response) {
                // 조회된 데이터가 없는 경우
                if(!response.length){
                   document.querySelector('.cm_list').innerHTML = '<div class="cm_none"><p>등록된 댓글이 없습니다.</p></div>';
                   return false;
                }
               
                let commentHtml = '';
            
                // 댓글 HTML 추가
                response.forEach(row => {
                    commentHtml += `
                       <div>
                           <span class="writer_img"><img src="/images/default_profile.png" width="30" height="30" alt="기본 프로필 이미지"/></span>
                           <p class="writer">
                               <em>${comments?.commentAuthorId}</em>
                               <span class="date">${dayjs(comments.createDate).format('YYYY-MM-DD HH:mm')}</span>
                           </p>
                           <div class="cont"><div class="txt_con">${comments.content}</div></div>
                           <p class="func_btns">
                               <button type="button" class="btns"><span class="icons icon_modify">수정</span></button>
                               <button type="button" class="btns"><span class="icons icon_del">삭제</span></button>
                           </p>
                       </div>
                  `;
               })
               
               // HTML 렌더링
               document.querySelector('.cm_list').innerHTML = commentHtml;
           },
           error : function (request, status, error) {
              console.log(error)
           }
           
       })
    }
}
window.onload = () => {
   findAllComment();
}
</script>
</html>