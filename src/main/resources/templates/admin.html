<!-- null 값만 있는 항목 정렬하려 할 때 오류남-->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>회원 관리</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 20px;
    background-color: #f9f9f9;
  }

  nav {
    margin-bottom: 10px;
  }

  nav a {
    text-decoration: none;
    color: #333;
    font-weight: bold;
    margin-right: 10px;
  }

  nav a:hover {
    color: #007BFF;
  }

  hr {
    border: none;
    height: 1px;
    background-color: #ccc;
    margin: 20px 0;
  }

  h2 {
    color: #444;
    margin-bottom: 10px;
  }

  select {
    padding: 5px;
    font-size: 14px;
    margin-bottom: 15px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background-color: #fff;
    margin-top: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  th, td {
    padding: 10px;
    border: 1px solid #ddd;
    text-align: center;
  }

  th {
    background-color: #f0f0f0;
    cursor: pointer;
    color: #333;
  }

  th:hover {
    background-color: #e0e0e0;
  }

  .delete-button {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 6px 12px;
    cursor: pointer;
    border-radius: 4px;
  }

  .delete-button:hover {
    background-color: #c82333;
  }

  .page-nav {
    padding: 10px;
  }

  .page-link {
    text-decoration: none;
    color: #007BFF;
    font-weight: bold;
    cursor: pointer;
  }

  .page-link:hover {
    text-decoration: underline;
  }

  .nowPage a {
    color: white;
    background-color: #007BFF;
    padding: 5px 10px;
    border-radius: 4px;
  }

  #insertBoard input[type="text"] {
    padding: 5px;
    margin-right: 5px;
  }

  #insertBoard button, .update-button {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
  }

  #insertBoard button:hover, .update-button:hover {
    background-color: #218838;
  }
</style>
<script th:inline="javascript">
const TableManager = {
  state: {
    sortDirections: [], // 각 컬럼의 정렬 방향 ('asc' or 'desc')
    sortName: [],       // 컬럼 이름 배열 (서버에서 쓰이는 컬럼명)
    lastSorted: 0,		// 마지막으로 클릭된 컬럼 번호
    page: 0,            // 현재 페이지 번호
    limit: 20,          // 한 페이지에 몇 개를 보여줄지
    order: "asc",       // 현재 정렬 방향
    sort: "id",         // 현재 정렬 기준 컬럼
    partial: false,		// 테이블 전체(컬럼)를 바꿀지 아니면 tbody만 바꿀지
    boardName: null, // board 이름 받아서 생성
    url: "users",		// 무엇에 관한 테이블인지
    totalPageCount: -1	// 페이지 몇까지 있나, 초기화 -1
  },

  // admin.html 처음 들어올 때 초기화
  init(url, sortNameArray) {
    this.state.sortName = sortNameArray;
    this.state.sortDirections = new Array(sortNameArray.length).fill("asc");
    this.state.sort = sortNameArray[0];
    this.state.order = "asc";
    this.state.url = url;
    
    document.addEventListener('DOMContentLoaded', () => {
        this.bindDeleteButtons();
    });
  },
  // 테이블 종류를 바꿀 때 동작 > ajax로 동작
  set(url, sortNameArray) {
    this.state.sortName = sortNameArray;
    this.state.sortDirections = new Array(sortNameArray.length).fill("asc");
    this.state.lastSorted = 0;
    this.state.page = 0;
    this.state.limit = 20;
    this.state.order = "asc";
    this.state.sort = sortNameArray[0];
    this.state.url = url;
    
    this.pageAjax();
  },
  // select option 변경될 때
  updateLimitSize(newsize) {
	this.state.limit = newsize
	this.state.partial = true;
	
	this.pageAjax();
  },
  // 칼럼을 누르면 오름차순 내림차순 바뀜 > ajax
  updateSort(col) {
	this.state.lastSorted = col;
	if (this.state.sortDirections[col] === "desc") {
		this.state.sortDirections[col] = "asc";
	} else if (this.state.sortDirections.includes("desc")) {
		this.state.sortDirections = new Array(this.state.sortName.length).fill("asc");
	} else {
		this.state.sortDirections = new Array(this.state.sortName.length).fill("asc");
		this.state.sortDirections[col] = "desc";
	}
	
	this.state.partial = true;
    this.state.sort = this.state.sortName[col];
    this.state.order = this.state.sortDirections[col];

    this.pageAjax();
  },
  // ajax 동작에 관한 함수 정보 받아오고 변수 정리
  pageAjax() {
    const { sort, order, page, limit, url, boardName } = this.state;
	if (this.state.partial) {
    	fetch(`/admin/${url}/partial?sortby=${sort}&orderby=${order}&page=${page}&limit=${limit}&url=${url}`)
	      .then(res => res.text())
	      .then(html => {
	        document.querySelector("tbody").innerHTML = html;
	        this.state.totalPageCount = document.getElementById('totalPageCount').value;
	        this.state.partial = false;
	        this.bindDeleteButtons();
	        this.changeList(this.state.totalPageCount < 0 ? [[${totalPageCount}]] : this.state.totalPageCount);
	        this.bindUpdateButtons();
	        this.updateSortIcons();
	      });
	} else {
	    fetch(`/admin/${url}`)
	      .then(res => res.text())
	      .then(html => {
	        document.querySelector("#listTableDiv").innerHTML = html;
	        this.state.totalPageCount = document.getElementById('totalPageCount').value;
	        this.state.partial = false;
	        this.bindDeleteButtons();
	        this.changeList(this.state.totalPageCount);
	        this.bindUpdateButtons();
	        this.updateSortIcons();
	      });
	}
  },
  
  // 게시판 생성 버튼 구현
  createBoard() {
	  const container = document.getElementById("insertBoard")
	  const name = document.getElementById("boardName").value;
	    if (name.trim() === "") {
	      alert("게시판 이름을 입력해주세요!");
	      return;
	    }
	    const params = {
	    	    sort: this.state.sort,
	    	    order: this.state.order,
	    	    page: this.state.page,
	    	    limit: this.state.limit,
	    	    url: this.state.url,
	    	    boardName: name
	    	  };

	    	  for (const key in params) {
	    	    const input = document.createElement('input');
	    	    input.type = 'hidden';
	    	    input.name = key;
	    	    input.value = params[key];
	    	    container.appendChild(input);
	    	  }
	    container.submit();
  },
	
	// 삭제 버튼 이벤트 ajax 되면 다시 넣어줘야
	bindDeleteButtons() {
	    document.querySelectorAll('.delete-button').forEach(button => {
	        button.addEventListener('click', function () {
	            const form = button.closest('form'); 
	            const id = form.querySelector('input[name="id"]').value;
	        	
	            if (!confirm(`id가 ${id}인 항목을 삭제하시겠습니까?`)) {
	                return; 
	            }
	
	            const params = {
	                sort: TableManager.state.sort,
	                order: TableManager.state.order,
	                page: TableManager.state.page,
	                limit: TableManager.state.limit,
	                url: TableManager.state.url,
	                lastSorted: TableManager.state.lastSorted
	            };
	
	            const paramsInput = form.querySelector('input[name="params"]');
	            paramsInput.value = new URLSearchParams(params).toString();
	
	            form.submit();
	        });
	    });
	},
  
  // 유저 등급 변경 메소드
  bindUpdateButtons() {
	    document.querySelectorAll('.update-button').forEach(button => {
	        button.addEventListener('click', function () {
	            const form = button.closest('form'); 
	            const id = form.querySelector('input[name="id"]').value;
	        	
	            const input = prompt(`${id}번 회원의 새로운 등급을 숫자(1~10)로 적어주세요`);

	            if (input === null || input.trim() === "") {
	              return;
	            } else if (isNaN(input)) {
	              alert("숫자만 입력해주세요.");
	            } else if (!Number.isInteger(Number(input)) || input >10 || input < 1) {
	              alert("정수(1~10)만 입력해주세요.");
	            } else {
	              const grade = parseInt(input);
	              
		          const params = {
			              sort: TableManager.state.sort,
			              order: TableManager.state.order,
			              page: TableManager.state.page,
			              limit: TableManager.state.limit,
			              url: TableManager.state.url,
			              lastSorted: TableManager.state.lastSorted
			          };
	
		          const paramsInput = form.querySelector('input[name="params"]');
		          paramsInput.value = new URLSearchParams(params).toString();
		          
		          form.querySelector('input[name="newGrade"]').value = grade;

		          form.submit();
	            }
	        });
	    });
	},
	// changeList, changePage, paging 페이지 관련 메소드
	// 실제로 페이지 바를 만드는 메소드
	changeList(pageCount) {
		let pagingtr =  document.getElementById("paging");
		
		totalPageCount = pageCount;

		let back = totalPageCount - 5 >= 1 ? totalPageCount - 5 : 1;
		let front = totalPageCount + 5 <= totalPageCount ? totalPageCount + 5 : totalPageCount
		        
		let backTo = back - 1 >= 1 ? back - 1 : 1;
		let frontTo = front + 1 <= totalPageCount ? front + 1 : totalPageCount;
		
        pagingtr.innerHTML = 
            `<td class='page-nav'>
                <a onclick="TableManager.changePage(${backTo})" class="page-link">&lt;&lt;</a>
            </td>` +
            this.paging(back, front) + 
            `<td class="page-nav">
                <a onclick="TableManager.changePage(${frontTo})" class="page-link">&gt;&gt;</a>
            </td>`;
	},
	// 버든에 들어가는 메소드 페이지 번호에 따라 ajax 동작
	changePage(movingPage) {
	    let page = document.getElementById("nowpage");
	    page.value = movingPage;
	    
	    this.state.page = movingPage - 1;
	    this.state.partial = true;
	    this.pageAjax();
	},
	// 페이지 버튼 반복 생성
	paging(back, front) {
	    let page = "";
	    
	    for(let i = back; i <= front; i++) {
	    	if(i == document.getElementById("nowpage").value) {
	    		page += `
	    			  <td class="page-nav nowPage">
	    			    <a onclick="TableManager.changePage(${i})" class="page-link">${i}</a>
	    			  </td>
				`;
	    		continue;
	    	}
			page += `
			  <td class="page-nav">
			    <a onclick="TableManager.changePage(${i})" class="page-link">${i}</a>
			  </td>
			  `;
	    }
	    return page;
	},
	
	updateSortIcons() {
		const headers = document.querySelectorAll("thead th");
		  headers.forEach((th, index) => {
		    const direction = this.state.sortDirections?.[index]; // "asc", "desc" 또는 undefined
		    let icon = "";
			if (index == this.state.lastSorted){
			    if (direction === "asc") {
				      icon = " 🔺"
				    } else if (direction === "desc") {
				      icon = " 🔻";
				    }
			} else {
			    if (direction === "asc") {
			      icon = " 🔼";
			    } else if (direction === "desc") {
			      icon = " 🔽";
			    }
			}
	
		    // 정렬 아이콘 중복 방지를 위해 기존 텍스트에서 아이콘 제거 후 다시 추가
		    const baseText = th.textContent.replace(/[🔼🔽🔺🔻]/g, "").trim(); // 🔼, 🔽 제거
		    th.textContent = baseText + icon;
		  });
	}
};
// 초기화
TableManager.init("users",["id", "nickname", "email", "reg_date", "last_access_date", "user_grade"]);
</script>
</head>
<body>
    <nav>
      <div class="nav-links">
        <a href="/" class="active"><i class="fas fa-home"></i> 홈</a>
        <a href="/board/list"><i class="fas fa-list"></i> 게시판</a>
        <a href="/file/read?note_id=1"><i class="fas fa-upload"></i> 파일 업로드</a>
        <a href="/login" th:if="${session.loginMember == null}"><i class="fas fa-sign-in-alt"></i> 로그인</a>
        <a href="/register" th:if="${session.loginMember == null}"><i class="fas fa-user-plus"></i> 회원가입</a>
        <a href="/logout" th:if="${session.loginMember != null}"><i class="fas fa-sign-out-alt"></i> 로그아웃</a>
        <a href="/admin"><i class="fas fa-cog"></i> 관리자</a>
      </div>
    </nav>
    <hr>
    <nav>
		<a href="#" onclick="TableManager.set('users', ['id', 'nickname', 'email', 'reg_date', 'last_access_date', 'user_grade'])">회원</a> |
		<a href="#" onclick="TableManager.set('boards', ['id', 'name', 'create_date', 'last_modified_date'])">게시판</a> |
		<a href="#" onclick="TableManager.set('notes', ['id', 'title', 'content', 'create_date', 'last_modified_date', 'board_id', 'user_id'])">게시글</a> |
		<a href="#" onclick="TableManager.set('comments', ['id', 'content', 'create_date', 'last_modified_date', 'comment_id', 'note_id', 'comment_author_id'])">댓글</a>
    </nav>
    <div id="listTableDiv">
    <h2>회원 목록</h2>
    <select id="pageLimitSelect" onchange="TableManager.updateLimitSize(this.value)" >
      <option value="none">=== 정렬 개수 선택 ===</option>
	  <option value="10">10</option>
	  <option value="20">20</option>
	  <option value="50">50</option>
	  <option value="100">100</option>
	</select>
    <table border="1">
        <thead><th onclick="TableManager.updateSort(0)">회원 번호</th><th onclick="TableManager.updateSort(1)">이름</th>
        	<th onclick="TableManager.updateSort(2)">이메일</th><th onclick="TableManager.updateSort(3)">가입일</th>
        	<th onclick="TableManager.updateSort(4)">마지막 접속일</th><th onclick="TableManager.updateSort(5)">등급</th>
        	<th>등급 변경</th><th>삭제</th></thead>
        <tbody>
		        <tr th:each="item: ${users}">
		        	<td th:text="${item.id}"></td>
		        	<td th:text="${item.nickName}"></td>
		        	<td th:text="${item.email}"></td>
		        	<td th:text="${item.regDate}"></td>
		        	<td th:text="${item.lastAccessDate}"></td>
		        	<td th:text="${item.userGrade}"></td>
		        	<td>
		        		<form class="update-grade" action="/admin/users/updateGrade" method="post">
		        			<input type="hidden" name="id" th:value="${item.id}" />
		        			<input type="hidden" name="newGrade" />
		        			<input type="hidden" name="params"/>
				        	<button type="button" class="update-button">등급 변경</button>
		        		</form>
		        	</td>
		        	<td>
		        		<form class="delete-form" action="/admin/users/delete" method="post">
		        			<input type="hidden" name="id" th:value="${item.id}" />
		        			<input type="hidden" name="params"/>
				        	<button type="button" class="delete-button">삭제</button>
		        		</form>
		        	</td>
		        </tr>
        </tbody>
    </table>
    </div>
   	<input id="nowpage" value=1 hidden="hidden">
    <table>
	    <tr id="paging">
	    </tr>
    </table>
<script th:inline="javascript">
TableManager.changeList([[${totalPageCount}]]);

// 삭제하고 돌아왔을 때 페이지 그대로 보이게 작동
window.onload = function() {
	TableManager.updateSortIcons();
	const urlParams = new URLSearchParams(window.location.search);
	
	const defaultUrl = urlParams.get('url');
	if (defaultUrl) {
		if (defaultUrl === "users") {
			TableManager.state.page = urlParams.get('page');
			TableManager.state.limit = urlParams.get('limit');
			TableManager.state.order = urlParams.get('order');
			TableManager.state.sort = urlParams.get('sort');
		    TableManager.state.url = defaultUrl;
			TableManager.set('users', ['id', 'nickname', 'email', 'reg_date', 'last_access_date', 'user_grade']);
		} else if (defaultUrl === "boards") {
			TableManager.state.page = urlParams.get('page');
			TableManager.state.limit = urlParams.get('limit');
			TableManager.state.order = urlParams.get('order');
			TableManager.state.sort = urlParams.get('sort');
		    TableManager.state.url = defaultUrl;
			TableManager.set('boards', ['id', 'name', 'create_date', 'last_modified_date']);
		} else if (defaultUrl === "notes") {
			TableManager.state.page = urlParams.get('page');
			TableManager.state.limit = urlParams.get('limit');
			TableManager.state.order = urlParams.get('order');
			TableManager.state.sort = urlParams.get('sort');
		    TableManager.state.url = defaultUrl;
			TableManager.set('notes', ['id', 'title', 'content', 'create_date', 'last_modified_date', 'board_id', 'user_id'])
		} else if (defaultUrl === "comments") {
			TableManager.state.page = urlParams.get('page');
			TableManager.state.limit = urlParams.get('limit');
			TableManager.state.order = urlParams.get('order');
			TableManager.state.sort = urlParams.get('sort');
		    TableManager.state.url = defaultUrl;
			TableManager.set('comments', ['id', 'content', 'create_date', 'last_modified_date', 'comment_id', 'note_id', 'comment_author_id'])
		} else {
			confirm('url 확인 필요');
		}
	}
}
</script>
</body>
</html>
