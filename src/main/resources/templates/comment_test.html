<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>게시글 상세</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        .reply { margin-left: 30px; }
        .edit-comment-form, .reply-form { display: none; }
    </style>
</head>
<body>
    <nav>
        <a href="/">홈</a> 
        <a href="/board/list">게시판</a> |
        <a href="/upload/list">파일 업로드</a> |
        <a href="/login">로그인</a> |
        <a href="/register">회원가입</a> |
        <a href="/admin/users">관리자</a>
    </nav>
    <hr>
    
    <h2>게시글 상세 보기</h2>
    <p><strong>제목:</strong> Spring Boot 게시판 만들기</p>
    <p><strong>작성자:</strong> admin</p>
    <p><strong>내용:</strong> 이 게시판은 Spring Boot와 Thymeleaf로 구현되었습니다.</p>
    <a href="board_modify.html">[수정]</a> | <a href="board_list.html">[목록]</a>
    <br><br><br><br><br><br>
    
    <div class="note-detail">
        <h2>게시글 제목</h2>
        <p>게시글 내용</p>

        <!-- 댓글 입력 폼 -->
        <h3>댓글 작성</h3>
        <form action="/comments/add" method="post">
            <input type="hidden" name="noteId" th:value="2"/>
            <input type="hidden" name="commentAuthorId" th:value="36"/>
            <textarea class="comment_content" name="content" rows="4" cols="50" maxlength="300" placeholder="댓글을 입력하세요"></textarea>
			<br>
			<span class="char-count">0</span>/300
	        <!-- 파일 업로드 -->
	        <input type="file" name="files" multiple /><br>
            <button type="submit">댓글 작성</button>
        </form>

        <!-- 댓글 목록 -->
        <h3>댓글 목록</h3>
        <ul>
            <li th:each="comment : ${comments}">
                <!-- 댓글 내용 -->
                <div class="comment-content">
                    <span th:text="${comment.commentAuthorId}">작성자</span>
                    <span th:text="${#temporals.format(comment.createDate, 'yyyy-MM-dd HH:mm')}">작성일</span>
                    <img alt="이미지" th:src="${comment.images}" />
                    <p class="comment_content" th:text="${comment.content}">댓글 내용</p>
                    <button type="button" class="edit-comment-btn">수정</button>
                    <form action="/comments/delete" method="post" style="display:inline;">
                        <input type="hidden" name="id" th:value="${comment.id}">
                        <input type="hidden" name="noteId" th:value="2">
                        <button type="submit">삭제</button>
                    </form>
                </div>
                <!-- 댓글 수정 폼 -->
                <form class="edit-comment-form" action="/comments/update" method="post">
                    <input type="hidden" name="id" th:value="${comment.id}">
                    <input type="hidden" name="noteId" th:value="2">
                    <input type="hidden" name="commentAuthorId" th:value="36"/>
		            <textarea class="comment_content" name="content" th:text="${comment.content}" rows="4" cols="50" maxlength="300" placeholder="댓글을 입력하세요"></textarea>
					<br>
					<span class="char-count">0</span>/300
			        <!-- 파일 업로드 -->
			        <input type="file" name="files" multiple /><br>
			        
                    <button type="submit">등록</button>
                    <button type="button" class="cancel-edit">취소</button>
                </form>
                <!-- 대댓글 작성 버튼 -->
                <button type="button" class="reply-toggle-btn">답글쓰기</button>
                <!-- 대댓글 입력 폼 -->
                <form class="reply-form" action="/comments/add" method="post" style="margin-top:10px;">
                    <input type="hidden" name="noteId" th:value="2"/>
                    <input type="hidden" name="commentAuthorId" th:value="36"/>
                    <input type="hidden" name="commentId" th:value="${comment.id}"/>
		            <textarea class="comment_content" name="content" rows="4" cols="50" maxlength="300" placeholder="댓글을 입력하세요"></textarea>
					<br>
					<span class="char-count">0</span>/300
			        <!-- 파일 업로드 -->
			        <input type="file" name="files" multiple /><br>
                    <button type="submit">등록</button>
                    <button type="button" class="reply-cancel-btn">취소</button>
                </form>
                <!-- 대댓글 목록 (1단계) -->
                <ul th:if="${not #lists.isEmpty(comment.children)}" class="reply">
                    <li th:each="reply : ${comment.children}">
                        <div class="comment-content">
                            <span th:text="${reply.commentAuthorId}">작성자</span>
                            <span th:text="${#temporals.format(reply.lastModifiedDate, 'yyyy-MM-dd HH:mm')}">작성일</span>
                            <p class="comment_content" th:text="${reply.content}">대댓글 내용</p>
                            <button type="button" class="edit-comment-btn">수정</button>
                            <form action="/comments/delete" method="post" style="display:inline;">
                                <input type="hidden" name="id" th:value="${reply.id}">
                                <input type="hidden" name="noteId" th:value="2">
                                <button type="submit">삭제</button>
                            </form>
                        </div>
                        <!-- 대댓글 수정 폼 -->
                        <form class="edit-comment-form" action="/comments/update" method="post">
                            <input type="hidden" name="id" th:value="${reply.id}">
                            <input type="hidden" name="noteId" th:value="2">
                            <input type="hidden" name="commentAuthorId" th:value="36"/>
                            <input type="hidden" name="commentId" th:value="${reply.commentId}"/>
                            <textarea class="comment_content" name="content" th:text="${reply.content}" rows="4" cols="50" maxlength="300" placeholder="댓글을 입력하세요"></textarea>
							<br>
							<span class="char-count">0</span>/300
					        <!-- 파일 업로드 -->
					        <input type="file" name="files" multiple /><br>
                            <button type="submit">등록</button>
                            <button type="button" class="cancel-edit">취소</button>
                        </form>
                    </li>
                </ul>
            </li>
        </ul>
    </div>
    <script type="text/javascript">
        // 댓글/대댓글/수정폼 글자수 카운팅
        const textareas = document.querySelectorAll('.comment_content');

        textareas.forEach(textarea => {
          const counter = textarea.parentElement.querySelector('.char-count');
          if (counter) {
            textarea.addEventListener('input', function() {
              counter.textContent = this.value.length;
            });
          }
        });

        $(function() {
            // 댓글/대댓글 수정 폼 토글
            $(document).on('click', '.edit-comment-btn', function() {
                var $content = $(this).closest('.comment-content');
                var commentText = $content.find('.comment_content').text().trim();
                if (!commentText) {
                    commentText = $content.contents().filter(function() {
                        return this.nodeType === 3;
                    }).text().trim();
                }
                var $form = $content.next('.edit-comment-form');
                var $textarea = $form.find('textarea');
                var $counter = $form.find('.char-count');
                $textarea.val(commentText);
                $counter.text(commentText.length);
                $content.hide();
                $form.show();
            });

            $(document).on('click', '.cancel-edit', function() {
                var $form = $(this).closest('.edit-comment-form');
                $form.hide();
                $form.prev('.comment-content').show();
            });

            // 대댓글 작성 폼 토글
            $(document).on('click', '.reply-toggle-btn', function() {
                var $li = $(this).closest('li');
                $li.find('.reply-form').show();
                $(this).hide();
            });

            $(document).on('click', '.reply-cancel-btn', function() {
                var $li = $(this).closest('li');
                $li.find('.reply-form').hide();
                $li.find('.reply-toggle-btn').show();
            });
        });
    </script>
</body>
</html>
